<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Label Generator</title>
  <style>
    @import url('https://fonts.googleapis.com/css?family=Merriweather');

    /* cyrillic-ext */
    @font-face {
      font-family: 'Merriweather';
      font-style: normal;
      font-weight: 400;
      font-stretch: 100%;
      src: url(https://fonts.gstatic.com/s/merriweather/v32/u-4D0qyriQwlOrhSvowK_l5UcA6zuSYEqOzpPe3HOZJ5eX1WtLaQwmYiScCmDxhtNOKl8yDr3icaGV31GvU.woff2) format('woff2');
      unicode-range: U+0460-052F, U+1C80-1C8A, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
    }
    /* cyrillic */
    @font-face {
      font-family: 'Merriweather';
      font-style: normal;
      font-weight: 400;
      font-stretch: 100%;
      src: url(https://fonts.gstatic.com/s/merriweather/v32/u-4D0qyriQwlOrhSvowK_l5UcA6zuSYEqOzpPe3HOZJ5eX1WtLaQwmYiScCmDxhtNOKl8yDr3icaEF31GvU.woff2) format('woff2');
      unicode-range: U+0301, U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
    }
    /* vietnamese */
    @font-face {
      font-family: 'Merriweather';
      font-style: normal;
      font-weight: 400;
      font-stretch: 100%;
      src: url(https://fonts.gstatic.com/s/merriweather/v32/u-4D0qyriQwlOrhSvowK_l5UcA6zuSYEqOzpPe3HOZJ5eX1WtLaQwmYiScCmDxhtNOKl8yDr3icaG131GvU.woff2) format('woff2');
      unicode-range: U+0102-0103, U+0110-0111, U+0128-0129, U+0168-0169, U+01A0-01A1, U+01AF-01B0, U+0300-0301, U+0303-0304, U+0308-0309, U+0323, U+0329, U+1EA0-1EF9, U+20AB;
    }
    /* latin-ext */
    @font-face {
      font-family: 'Merriweather';
      font-style: normal;
      font-weight: 400;
      font-stretch: 100%;
      src: url(https://fonts.gstatic.com/s/merriweather/v32/u-4D0qyriQwlOrhSvowK_l5UcA6zuSYEqOzpPe3HOZJ5eX1WtLaQwmYiScCmDxhtNOKl8yDr3icaGl31GvU.woff2) format('woff2');
      unicode-range: U+0100-02BA, U+02BD-02C5, U+02C7-02CC, U+02CE-02D7, U+02DD-02FF, U+0304, U+0308, U+0329, U+1D00-1DBF, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F, U+A720-A7FF;
    }
    /* latin */
    @font-face {
      font-family: 'Merriweather';
      font-style: normal;
      font-weight: 400;
      font-stretch: 100%;
      src: url(https://fonts.gstatic.com/s/merriweather/v32/u-4D0qyriQwlOrhSvowK_l5UcA6zuSYEqOzpPe3HOZJ5eX1WtLaQwmYiScCmDxhtNOKl8yDr3icaFF31.woff2) format('woff2');
      unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
    }

    body {
      margin: 0;
      padding: 0;
    }

    @media print {
      body {
        margin: 0;
      }
      .product-selector {
        display: none;
      }
    }

    .page-break {
      break-after: page;
    }

    .product-selector {
      margin: 20px 0;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #dee2e6;
    }

    .product-selector label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
      font-family: 'Merriweather', serif;
    }

    .product-selector select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ced4da;
      border-radius: 6px;
      font-size: 16px;
      background-color: white;
      font-family: 'Merriweather', serif;
    }

    .product-selector select:focus {
      outline: none;
      border-color: #007bff;
      box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
    }

    #front, #back {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      gap: 10px;
      width: fit-content;
    }

    .label {
      --s: 60px;     /* control the shape */
      --border: 2px; /* border width */

      margin: 8px;
      height: 2cm;
      width: 12cm;

      position: relative;
      background: #000; /* inner background */      
    }

    #front .label{
      clip-path: polygon(
        var(--s) 0,
        100% 0,
        100% 100%,
        var(--s) 100%,
        0 50%
      );
    }
    #front .label::before {
      clip-path: polygon(
        var(--s) 0,
        100% 0,
        100% 100%,
        var(--s) 100%,
        0 50%
      );
    }

    #back .label {
      clip-path: polygon(
        0 0,
        calc(100% - var(--s)) 0,
        100% 50%,
        calc(100% - var(--s)) 100%,
        0 100%
      );
    }
    #back .label::before {
      clip-path: polygon(
        0 0,
        calc(100% - var(--s)) 0,
        100% 50%,
        calc(100% - var(--s)) 100%,
        0 100%
      );
    }
    .back-image { margin-left: 0px;}

    .qr-code {
      position: absolute;
      top: 2px;
      left: 2px;
      height: calc(100% - 5px);
    }

    .flower-wrapper {
      position: absolute;
      top: 2px;
      right: 1px;
      height: 72px;
      width: 71px;
      overflow: hidden;
      border-left: 2px solid black;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .flower {
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: center center;
      min-width: 100%;
      min-height: 100%;
    }

    /* Outer shape (fake border) */
    .label::before {
      content: "";
      position: absolute;
      top: calc(1 * var(--border));
      left: calc(1 * var(--border));
      right: calc(1 * var(--border));
      bottom: calc(1 * var(--border));
      background: white;      
    }

    .logo-wrapper {
      position: absolute;
      top: 10px;
      left: 74px;
    }
    .logo-wrapper span {
      font-family: 'Merriweather', serif;
      font-weight: 700;
      font-size: 30px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .logo-wrapper img {
      width: 30px;
      height: 30px;
    }
    .text-wrapper {
      position: absolute;
      top: 18px;
      right: 91px;
      font-size: 29px;
      color: black;
      font-weight: bold;
      font-family: 'Merriweather', serif;
    }
    .logo-wrapper p {
      font-size: 14px;
      position: absolute;
      top: 38px;
      left: 1px;
      margin: 0;
      width: 310px;
      font-family: sans-serif;
    }
    .back-image {
      margin: 0px 5px 0px 0px;
    }
  </style>
</head>
<body>
  <div class="product-selector">
    <label for="productSelect">Välj produkt:</label>
    <select id="productSelect">
    </select>
  </div>
  <div id="front">
    <div class="label">
      <div class="flower-wrapper">
        <img src="assets/images/blog/madcat.jpg" class="flower" />
      </div>
      <div class="text-wrapper">
        <span>Rob's Mad Cat</span>
      </div>
    </div>
    <!-- Additional labels will be generated by JavaScript -->
  </div>
  <div id="back">
    <div class="label">
      <img src="assets/images/generator/qr-code-linktree.png" alt="QR Code" class="qr-code" />
      <div class="logo-wrapper">
        <span>
          <img src="assets/images/generator/leaf-black.svg" alt="#" class="leaf-logo" />
          Drumla
        </span>
        <p>Scanna QR-koden för skötselråd, info & länkar.</p>
      </div>
    </div>
    <!-- Additional labels will be generated by JavaScript -->
  </div>
  <div id="canvas-wrapper"></div>

  <!-- html2canvas script -->
  <script src="https://cdn.jsdelivr.net/npm/dom-to-image@2.6.0/dist/dom-to-image.min.js"></script>
  <script type="module">
    import config from '/products.json' with { type: 'json' };
    
    var useDomToImage = true;
    var numberOfLabels = 26;
    var productsData = config;

    // Populate the product dropdown
    function populateProductDropdown() {
      const productSelect = document.getElementById('productSelect');
      if (!productSelect || !productsData) return;

      // Clear existing options
      productSelect.innerHTML = '';

      // Add products to dropdown
      productsData.products.forEach((product, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = product.title;
        
        // Set the first product (Rob's Mad Cat) as selected by default
        if (index === 0) {
          option.selected = true;
        }
        
        productSelect.appendChild(option);
      });

      // Add event listener for product selection
      productSelect.addEventListener('change', function() {
        const selectedIndex = this.value;
        if (selectedIndex !== '') {
          updateProductDisplay(productsData.products[selectedIndex]);
        }
      });
    }

    // Update the product display based on selection
    function updateProductDisplay(product) {
      // Update the flower image
      const flowerImg = document.querySelector('.flower');
      if (flowerImg) {
        flowerImg.src = product.imagePath;
        flowerImg.alt = product.title;
        
        // Wait for the image to load before regenerating labels
        const newImg = new Image();
        newImg.onload = function() {
          // Image has loaded, now update the text and regenerate
          updateTextAndRegenerateLabels(product);
        };
        newImg.onerror = function() {
          // If image fails to load, still update text and regenerate
          console.warn('Failed to load image:', product.imagePath);
          updateTextAndRegenerateLabels(product);
        };
        newImg.src = product.imagePath;
      } else {
        // If no flower image found, just update text and regenerate
        updateTextAndRegenerateLabels(product);
      }
    }

    function updateTextAndRegenerateLabels(product) {
      // Update the text wrapper
      const textWrapper = document.querySelector('.text-wrapper span');
      if (textWrapper) {
        textWrapper.textContent = product.title;
      }

      // Small delay to ensure DOM has updated, then regenerate
      setTimeout(() => {
        generateLabels();
      }, 100);
    }

    // Function to generate labels (labels + images)
    function generateLabels() {
      // First clear any existing generated images and page breaks
      const existingImages = document.querySelectorAll('.front-image, .back-image');
      const existingPageBreaks = document.querySelectorAll('.page-break');
      
      existingImages.forEach(img => img.remove());
      existingPageBreaks.forEach(pageBreak => pageBreak.remove());

      // Show the original elements in case they were hidden
      const frontNode = document.getElementById('front');
      const backNode = document.getElementById('back');
      frontNode.style.display = 'grid';
      backNode.style.display = 'grid';

      // Generate labels
      generateLabelsGrid();

      if (useDomToImage) {
        var scale = 2;

        // Generate image for front
        domtoimage.toPng(frontNode, {
          height: frontNode.offsetHeight * scale,
          style: {
            transform: `scale(${scale}) translate(${frontNode.offsetWidth / 2 / scale}px, ${frontNode.offsetHeight / 2 / scale}px)`
          },
          width: frontNode.offsetWidth * scale
        })
          .then(function (dataUrl) {
            var img = new Image();
            img.src = dataUrl;
            img.title = 'Front';
            img.height = frontNode.offsetHeight;
            img.width = frontNode.offsetWidth;
            img.className = 'front-image';
            document.body.appendChild(img);
            
            // Add page break div
            var pageBreak = document.createElement('div');
            pageBreak.className = 'page-break';
            document.body.appendChild(pageBreak);
            
            // Generate image for back
            return domtoimage.toPng(backNode, {
              height: backNode.offsetHeight * scale,
              style: {
                transform: `scale(${scale}) translate(${backNode.offsetWidth / 2 / scale}px, ${backNode.offsetHeight / 2 / scale}px)`
              },
              width: backNode.offsetWidth * scale
            });
          })
          .then(function (dataUrl) {
            var img = new Image();
            img.src = dataUrl;
            img.title = 'Back';
            img.height = backNode.offsetHeight;
            img.width = backNode.offsetWidth;
            img.className = 'back-image';
            document.body.appendChild(img);
            
            // Hide the original elements
            frontNode.style.display = 'none';
            backNode.style.display = 'none';
          })
          .catch(function (error) {
            console.error('oops, something went wrong!', error);
          });
      }
    }

    function generateLabelsGrid() {
      // Generate labels for both front and back
      var containers = ['front', 'back'];
      
      containers.forEach(function(containerId) {
        var labelContainer = document.getElementById(containerId);
        
        // Get the first label element as a template
        var templateLabel = labelContainer.querySelector('.label');
        
        if (!templateLabel) {
          console.error('No template label found in ' + containerId);
          return;
        }
        
        // Remove all existing labels except the first one
        var existingLabels = labelContainer.querySelectorAll('.label');
        for (var i = 1; i < existingLabels.length; i++) {
          existingLabels[i].remove();
        }
        
        // Clone the template to create additional labels
        for (var i = 1; i < numberOfLabels; i++) {
          var clonedLabel = templateLabel.cloneNode(true);
          labelContainer.appendChild(clonedLabel);
        }
      });
    }

    window.onload = function () {
      // Populate dropdown since products are already loaded
      populateProductDropdown();
      
      // Generate initial labels
      generateLabels();
    };
  </script>
</body>
</html>
